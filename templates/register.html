<!-- register.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-0 rounded-4">
            <!-- Encabezado Amarillo -->
            <div class="card-header bg-warning text-dark text-center py-3 rounded-top-4">
                <h4 class="mb-0 fw-bold">Registro de Usuario</h4>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    
                    <!-- Selección de Tipo -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Tipo de Usuario:</label>
                        <select class="form-select form-select-lg border-warning" id="userTypeSelect" name="tipo_registro" onchange="toggleForm()">
                            <option value="Persona">Persona</option>
                            <option value="Empresa">Empresa</option>
                        </select>
                    </div>

                    <!-- Campos Comunes (Email/Pass) -->
                    <div class="row">
                         <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Email *</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                    </div>
                    
                    <!-- Contraseñas con Ojo -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Contraseña *</label>
                            <div class="input-group">
                                <input type="password" class="form-control border-end-0" name="password" id="passwordInput" required style="border-color: #ced4da;">
                                <button class="btn border border-start-0 text-muted" type="button" id="togglePasswordBtn" style="background-color: white; border-color: #ced4da;">
                                    <i class="bi bi-eye" id="toggleIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Verificar Contraseña *</label>
                            <div class="input-group">
                                <input type="password" class="form-control border-end-0" name="confirm_password" id="confirmPasswordInput" required style="border-color: #ced4da;">
                                <button class="btn border border-start-0 text-muted" type="button" id="toggleConfirmBtn" style="background-color: white; border-color: #ced4da;">
                                    <i class="bi bi-eye" id="toggleConfirmIcon"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Campos Persona -->
                    <div id="formPersona">
                        <h5 class="text-dark border-bottom border-warning pb-2 mb-3 fw-bold">Datos Personales</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Avatar o imagen</label>
                            <input type="file" name="avatar" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Nombre *</label>
                                <!-- Validación de nombre -->
                                <input type="text" name="nombre" class="form-control" id="req_nombre" oninput="validateNameInput(this)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Primer Apellido *</label>
                                <!-- Validación de nombre -->
                                <input type="text" name="primer_apellido" class="form-control" id="req_apellido1" oninput="validateNameInput(this)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Segundo Apellido</label>
                                <!-- Validación de nombre -->
                                <input type="text" name="segundo_apellido" class="form-control" oninput="validateNameInput(this)">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Teléfono | Celular *</label>
                                <!-- Validación estricta de teléfono (8 dígitos numéricos) -->
                                <input type="text" name="telefono" class="form-control" id="req_tel" 
                                       maxlength="8" minlength="8" pattern="\d{8}" inputmode="numeric" 
                                       title="Debe tener exactamente 8 números" oninput="validatePhoneInput(this)">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Whatsapp</label>
                                <!-- Validación estricta de teléfono -->
                                <input type="text" name="whatsapp" class="form-control" 
                                       maxlength="8" minlength="8" pattern="\d{8}" inputmode="numeric" 
                                       title="Debe tener exactamente 8 números" oninput="validatePhoneInput(this)">
                            </div>
                        </div>
                    </div>

                    <!-- Campos Empresa -->
                    <div id="formEmpresa" style="display: none;">
                        <h5 class="text-dark border-bottom border-warning pb-2 mb-3 fw-bold">Datos de Empresa</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre Empresa *</label>
                            <input type="text" name="nombre_empresa" class="form-control" id="req_empresa">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Encargado</label>
                                <input type="text" name="encargado" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Contacto *</label>
                                <input type="text" name="contacto" class="form-control" id="req_contacto">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Teléfono Fijo</label>
                                <!-- Validación estricta de teléfono -->
                                <input type="text" name="telefono_fijo" class="form-control" 
                                       maxlength="8" minlength="8" pattern="\d{8}" inputmode="numeric" 
                                       title="Debe tener exactamente 8 números" oninput="validatePhoneInput(this)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Móvil</label>
                                <!-- Validación estricta de teléfono -->
                                <input type="text" name="movil" class="form-control" 
                                       maxlength="8" minlength="8" pattern="\d{8}" inputmode="numeric" 
                                       title="Debe tener exactamente 8 números" oninput="validatePhoneInput(this)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Whatsapp</label>
                                <!-- Validación estricta de teléfono -->
                                <input type="text" name="whatsapp_empresa" class="form-control" 
                                       maxlength="8" minlength="8" pattern="\d{8}" inputmode="numeric" 
                                       title="Debe tener exactamente 8 números" oninput="validatePhoneInput(this)">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Dirección (URL o Texto)</label>
                            <input type="text" name="direccion" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Otros Detalles</label>
                            <textarea name="otros_detalles" class="form-control"></textarea>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-warning btn-lg fw-bold rounded-pill px-5">Registrarse</button>
                    </div>
                    <div class="mt-3 text-center">
                        <a href="{{ url_for('login') }}" class="link-dark text-decoration-none">Ya tengo una cuenta</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Lógica para alternar visibilidad de formularios (Persona/Empresa)
    function toggleForm() {
        var tipo = document.getElementById("userTypeSelect").value;
        var personaDiv = document.getElementById("formPersona");
        var empresaDiv = document.getElementById("formEmpresa");
        
        var reqPersona = [document.getElementById("req_nombre"), document.getElementById("req_apellido1"), document.getElementById("req_tel")];
        var reqEmpresa = [document.getElementById("req_empresa"), document.getElementById("req_contacto")];

        if (tipo === "Persona") {
            personaDiv.style.display = "block";
            empresaDiv.style.display = "none";
            reqPersona.forEach(el => el.required = true);
            reqEmpresa.forEach(el => el.required = false);
        } else {
            personaDiv.style.display = "none";
            empresaDiv.style.display = "block";
            reqPersona.forEach(el => el.required = false);
            reqEmpresa.forEach(el => el.required = true);
        }
    }
    toggleForm();

    // Lógica para mostrar/ocultar contraseñas
    function setupPasswordToggle(inputId, btnId, iconId) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        const icon = document.getElementById(iconId);

        btn.addEventListener('click', function() {
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            
            if (type === 'text') {
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    }

    // Configurar ambos campos
    setupPasswordToggle('passwordInput', 'togglePasswordBtn', 'toggleIcon');
    setupPasswordToggle('confirmPasswordInput', 'toggleConfirmBtn', 'toggleConfirmIcon');

    // Validación para Nombres/Apellidos: Solo letras, sin espacios/números, formato Title
    function validateNameInput(input) {
        let value = input.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ]/g, '');
        if (value.length > 0) {
            value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        }
        input.value = value;
    }

    // Validación para Teléfonos: Solo números, exactamente 8 dígitos
    function validatePhoneInput(input) {
        // Eliminar todo lo que no sea dígito
        let value = input.value.replace(/\D/g, '');
        
        // Limitar estrictamente a 8 dígitos
        if (value.length > 8) {
            value = value.slice(0, 8);
        }
        
        input.value = value;
    }
</script>
{% endblock %}