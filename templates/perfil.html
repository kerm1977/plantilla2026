<!-- perfil.html -->
{% extends 'base.html' %}

{% block content %}
<style>
    .profile-card:hover {
        transform: none !important;
    }

    /* FIX: Permitir transparencia en imágenes PNG manteniendo el borde */
    .avatar-container {
        width: 100px; /* REDUCIDO: Tamaño más pequeño para el avatar */
        height: 100px; /* REDUCIDO: Tamaño más pequeño para el avatar */
        background-color: transparent !important; /* Quita el fondo blanco sólido */
        border: 4px solid #fff; /* Crea el anillo blanco como borde real (ligeramente más fino) */
        padding: 0 !important; /* Elimina el relleno que actuaba como fondo */
        border-radius: 50%; /* Asegura la forma circular */
        overflow: hidden; /* Recorta cualquier esquina cuadrada de la imagen */
        
        /* Ajuste para mantener el centrado vertical si está flotando (override opcional) */
        bottom: -50px; 
    }
    
    /* Asegura que la imagen llene el contenedor correctamente y respete el recorte */
    .profile-avatar {
        background-color: transparent; 
        width: 100%;
        height: 100%;
        object-fit: cover; /* CLAVE: Mantiene el aspecto del recorte sin deformar */
        object-position: center; /* Centra la imagen por si acaso */
        border-radius: 50%; /* REFUERZO CRÍTICO: Fuerza a la imagen misma a ser redonda */
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        
        <!-- Tarjeta de Perfil -->
        <div class="card profile-card shadow-lg border-0 mb-5">
            
            <div class="card-header bg-warning profile-header text-center border-0">
                <div class="avatar-container mx-auto">
                    <!-- MODIFICADO: Fallback a logo.png si falla la imagen o es default -->
                    <img src="{{ url_for('static', filename='img/' + current_user.avatar) }}" 
                         alt="Avatar" 
                         class="profile-avatar"
                         onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/logo.png') }}';">
                </div>
            </div>

            <div class="card-body pt-5 text-center">
                <h3 class="mt-4 mb-1">{{ current_user.nombre if current_user.user_type == 'Persona' else current_user.nombre_empresa }}</h3>
                <!-- ROL ELIMINADO AQUÍ -->

                <div class="text-start px-md-4">
                    <div class="info-group">
                        <label class="text-muted small fw-bold text-uppercase">Correo Electrónico</label>
                        <p class="fs-6">{{ current_user.email }}</p>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="info-group">
                                <label class="text-muted small fw-bold text-uppercase">Whatsapp</label>
                                <p class="fs-6">{{ current_user.whatsapp if current_user.whatsapp else 'No registrado' }}</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="info-group">
                                <label class="text-muted small fw-bold text-uppercase">Teléfono</label>
                                <p class="fs-6">
                                    {% if current_user.user_type == 'Persona' %}
                                        {{ current_user.telefono }}
                                    {% else %}
                                        {{ current_user.telefono_fijo if current_user.telefono_fijo else current_user.movil }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% if current_user.user_type == 'Empresa' %}
                    <div class="info-group">
                        <label class="text-muted small fw-bold text-uppercase">Contacto / Encargado</label>
                        <p class="fs-6">{{ current_user.encargado }}</p>
                    </div>
                    <div class="info-group">
                        <label class="text-muted small fw-bold text-uppercase">Dirección</label>
                        <p class="fs-6">{{ current_user.direccion }}</p>
                    </div>
                    {% endif %}
                </div>

                <hr class="my-4">

                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <!-- ESTE BOTÓN LLEVA A LA PÁGINA DE EDICIÓN -->
                    <a href="{{ url_for('editar_perfil') }}" class="btn btn-outline-dark px-4 rounded-pill">
                        <i class="bi bi-pencil-square"></i> Editar Información
                    </a>
                    
                    <button type="button" class="btn btn-warning px-4 rounded-pill fw-bold" data-bs-toggle="modal" data-bs-target="#passwordModal">
                        <i class="bi bi-key"></i> Cambiar Contraseña
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE MENSAJES -->
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-dark text-white py-3 rounded-top-4 d-flex align-items-center">
                <i class="bi bi-envelope-open-fill text-warning me-2 fs-5"></i>
                <h5 class="mb-0 fw-bold">Buzón de Mensajes</h5>
                
                <!-- LÓGICA DE CONTADOR: Solo cuenta los NO leídos (is_read == False) -->
                {% set unread_count = messages | selectattr('is_read', 'equalto', False) | list | length %}
                <span id="msgBadge" class="badge bg-danger ms-2 rounded-pill shadow-sm border border-light" 
                      {% if unread_count == 0 %}style="display:none"{% endif %}>
                    {{ unread_count }}
                </span>
            </div>
            <div class="card-body p-0">
                {% if messages %}
                    <div class="accordion accordion-flush" id="messagesAccordion">
                        {% for msg in messages %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ msg.id }}">
                                <!-- Agregamos data-msg-id y onclic para detectar lectura -->
                                <button class="accordion-button collapsed fw-bold" type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#collapse{{ msg.id }}"
                                        data-msg-id="{{ msg.id }}"
                                        onclick="markAsRead(this, {{ msg.id }})"
                                        {% if not msg.is_read %}style="background-color: #fff8e1;"{% endif %}>
                                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                        <!-- Indicador visual si no ha sido leído -->
                                        <span class="text-truncate {% if not msg.is_read %}fw-bolder text-dark{% else %}fw-normal{% endif %}">
                                            {% if not msg.is_read %}<i class="bi bi-circle-fill text-warning me-2 small" id="dot{{ msg.id }}"></i>{% endif %}
                                            {{ msg.subject }}
                                        </span>
                                        <small class="text-muted" style="font-size: 0.75rem;">{{ msg.created_at.strftime('%d/%m/%Y') }}</small>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ msg.id }}" class="accordion-collapse collapse" data-bs-parent="#messagesAccordion">
                                <div class="accordion-body bg-light text-secondary">
                                    {{ msg.body }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-4 mb-3 d-block opacity-25"></i>
                        No tienes mensajes nuevos.
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- Modal Cambiar Contraseña -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning border-0">
                <h5 class="modal-title fw-bold">Cambiar Contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <!-- Action apunta explícitamente a cambiar_password -->
            <form action="{{ url_for('cambiar_password') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted">Contraseña Actual</label>
                        <input type="password" name="current_password" class="form-control bg-light" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Nueva Contraseña</label>
                        <input type="password" name="new_password" class="form-control bg-light" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Repetir Contraseña</label>
                        <input type="password" name="confirm_new_password" class="form-control bg-light" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-dark px-4 rounded-pill">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Función para marcar mensaje como leído al abrirlo
    function markAsRead(element, msgId) {
        // Verificar si ya fue marcado visualmente para no spamear el servidor
        if (element.getAttribute('data-read') === 'true') return;

        // Llamada AJAX al backend
        fetch(`/user/message/${msgId}/read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 1. Actualizar contador del Badge
                const badge = document.getElementById('msgBadge');
                if (badge) {
                    badge.innerText = data.unread_count;
                    if (data.unread_count === 0) {
                        badge.style.display = 'none';
                    }
                }

                // 2. Actualizar estilo visual del mensaje (quitar negrita y fondo)
                element.style.backgroundColor = ''; // Quitar fondo amarillo suave
                const textSpan = element.querySelector('span.text-truncate');
                if (textSpan) {
                    textSpan.classList.remove('fw-bolder', 'text-dark');
                    textSpan.classList.add('fw-normal');
                }
                
                // 3. Quitar el punto amarillo
                const dot = document.getElementById(`dot${msgId}`);
                if (dot) dot.remove();

                // Marcar como procesado localmente
                element.setAttribute('data-read', 'true');
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}